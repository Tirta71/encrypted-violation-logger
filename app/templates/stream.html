{% extends "base.html" %} {% block title %}Live Kamera{% endblock %} {% block
content %}

<!-- Header -->
<div class="px-4 py-4 mb-4 bg-dark text-white rounded-4 shadow-sm">
  <h2 class="mb-1">üìπ Live Kamera Raspberry Pi</h2>
  <p class="text-light mb-0">
    Menampilkan siaran langsung dan hasil deteksi OCR dari kendaraan secara
    real-time.
  </p>
</div>

<!-- Loading Spinner -->
<div
  id="loading-overlay"
  style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.7);
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(3px);
  "
>
  <div
    class="spinner-border text-dark"
    role="status"
    style="width: 3rem; height: 3rem"
  >
    <span class="visually-hidden">Loading...</span>
  </div>
  <p class="text-dark mt-3 fw-bold">Memproses plat nomor...</p>
</div>

<!-- Konten Utama -->
<div class="row gx-4 gy-4">
  <!-- Streaming Kamera -->
  <div class="col-lg-7">
    <div class="card border-0 shadow rounded-4 overflow-hidden h-100">
      <div class="bg-dark text-white px-4 py-3">
        <i class="bi bi-broadcast-pin me-2"></i>
        <strong>Streaming Kamera</strong>
      </div>

      <!-- Kontainer frame kamera -->
      <div
        class="card-body bg-white d-flex justify-content-center align-items-center"
        style="height: 400px"
      >
        <!-- Awalnya tampilkan stream -->
        <img
          id="live-view"
          src="{{ url_for('main.video_feed') }}"
          style="width: 100%; border-radius: 10px"
        />
      </div>

      <!-- Keterangan bawah -->
      <div class="py-2 text-center">
        <p class="text-muted mb-0 small">
          üîÅ Streaming langsung dari Raspberry Pi
        </p>
      </div>
      <div class="text-end px-4 py-2">
        <button
          id="reset-button"
          class="btn btn-sm btn-outline-dark"
          onclick="resetToStream()"
          style="display: none"
        >
          üîÅ Kembali ke Live Stream
        </button>
      </div>
    </div>
  </div>

  <!-- Informasi Deteksi dan Gambar -->
  <div class="col-lg-5 d-flex flex-column gap-4">
    {% for record in records %}
    <div class="card border-0 shadow rounded-4">
      <div class="bg-dark text-white px-4 py-3">
        <i class="bi bi-bar-chart-line me-2"></i>
        <strong
          >Pelanggaran: {{ record.waktu.strftime('%d-%m-%Y %H:%M:%S') }}</strong
        >
      </div>

      <!-- Confidence -->
      <div class="bg-white p-3">
        <p class="mb-2">
          <strong>Tingkat Akurasi:</strong>
          <span class="badge bg-dark text-white fs-6 px-3 py-1"
            >{{ record.confidence or 0 }}%</span
          >
        </p>

        <!-- Plat Nomor -->
        <p class="mb-2">
          <strong>Plat Nomor:</strong>
          <span class="text-uppercase fw-bold"
            >{{ record.plat_nomor or "Belum tersedia" }}</span
          >
        </p>

        <!-- Validasi -->
        <p class="mb-2">
          <strong>Poly1305:</strong>
          {% if record.keamanan %} {% if record.keamanan.poly1305_valid %}
          <span class="badge bg-success fs-6 px-3 py-1">VALID</span>
          {% else %}
          <span class="badge bg-danger fs-6 px-3 py-1">TIDAK VALID</span>
          {% endif %} {% else %}
          <span class="badge bg-secondary fs-6 px-3 py-1"
            >Belum Diverifikasi</span
          >
          {% endif %}
        </p>

        <!-- Gambar -->
        {% if record.gambars %}
        <div class="row">
          {% for gambar in record.gambars %}
          <div class="col-6 text-center mb-3">
            <img
              src="{{ url_for('static', filename='gambar_plat/' ~ gambar.nama_file) }}"
              alt="{{ gambar.nama_file }}"
              class="img-fluid rounded shadow-sm"
              style="max-height: 150px; object-fit: contain"
              onerror="this.onerror=null; this.src='{{ url_for('static', filename='img/error404.png') }}';"
            />
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p class="text-muted text-center mb-0">Tidak ada gambar tersedia.</p>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<script>
  let latestTime =
    "{{ records[0].waktu.isoformat() if records and records[0].waktu else '' }}";
  let hasSwitchedToImage = false;

  function resetToStream() {
    const view = document.getElementById("live-view");
    view.src = "{{ url_for('main.video_feed') }}";
    hasSwitchedToImage = false;
    document.getElementById("reset-button").style.display = "none";
  }

  setInterval(() => {
    fetch("/api/latest-time")
      .then((res) => res.json())
      .then((data) => {
        if (
          !hasSwitchedToImage &&
          data.last_time &&
          data.last_time !== latestTime
        ) {
          latestTime = data.last_time;
          document.getElementById("loading-overlay").style.display = "flex";

          setTimeout(() => {
            // Ganti ke gambar terbaru
            const view = document.getElementById("live-view");
            view.src = "/stream/latest-image?cache=" + new Date().getTime();
            hasSwitchedToImage = true;

            // Ambil data pelanggaran terbaru
            fetch("/api/latest-records")
              .then((res) => res.json())
              .then((records) => {
                const container = document.querySelector(".col-lg-5");
                container.innerHTML = ""; // kosongkan isi lama

                records.forEach((r) => {
                  const badge =
                    r.poly1305_valid === true
                      ? `<span class="badge bg-success fs-6 px-3 py-1">VALID</span>`
                      : r.poly1305_valid === false
                      ? `<span class="badge bg-danger fs-6 px-3 py-1">TIDAK VALID</span>`
                      : `<span class="badge bg-secondary fs-6 px-3 py-1">Belum Diverifikasi</span>`;

                  const gambarHTML = r.gambar
                    ? `<div class="col-6 text-center mb-3">
                        <img src="${r.gambar}" class="img-fluid rounded shadow-sm" style="max-height: 150px; object-fit: contain;" />
                      </div>`
                    : `<p class="text-muted text-center mb-0">Tidak ada gambar tersedia.</p>`;

                  container.innerHTML += `
                    <div class="card border-0 shadow rounded-4">
                      <div class="bg-dark text-white px-4 py-3">
                        <i class="bi bi-bar-chart-line me-2"></i>
                        <strong>Pelanggaran: ${r.waktu}</strong>
                      </div>
                      <div class="bg-white p-3">
                        <p class="mb-2"><strong>Tingkat Akurasi:</strong>
                          <span class="badge bg-dark text-white fs-6 px-3 py-1">${r.confidence}%</span>
                        </p>
                        <p class="mb-2"><strong>Plat Nomor:</strong>
                          <span class="text-uppercase fw-bold">${r.plat_nomor}</span>
                        </p>
                        <p class="mb-2"><strong>Poly1305:</strong> ${badge}</p>
                        <div class="row">${gambarHTML}</div>
                      </div>
                    </div>`;
                });
              });

            document.getElementById("loading-overlay").style.display = "none";
            document.getElementById("reset-button").style.display =
              "inline-block";
          }, 1500);
        }
      });
  }, 3000);
</script>

{% endblock %}
